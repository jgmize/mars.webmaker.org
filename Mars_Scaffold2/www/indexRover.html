<!DOCTYPE html>
<!--[if lt IE 7 ]> <html class="ie ie6 no-js" lang="en"> <![endif]-->
<!--[if IE 7 ]>    <html class="ie ie7 no-js" lang="en"> <![endif]-->
<!--[if IE 8 ]>    <html class="ie ie8 no-js" lang="en"> <![endif]-->
<!--[if IE 9 ]>    <html class="ie ie9 no-js" lang="en"> <![endif]-->
<!--[if gt IE 9]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>MSL Curiosity</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"> 
<meta name="description" content="" />
<meta name="keywords" content="Curiosity" />
<meta name="author" content="MX" />
<LINK REL="SHORTCUT ICON" HREF="images/mars.ico"> 
<link rel="stylesheet" type="text/css" href="css/mars.css" />
<link href="css/custom-theme/jquery-ui-1.10.2.custom.css" rel="stylesheet">
<link href='http://fonts.googleapis.com/css?family=Lato:100,300,400,700,900,100italic,300italic,400italic,700italic,900italic' rel='stylesheet' type='text/css'>

<script type="text/javascript" src="./js/popcorn-complete.js"></script>	
<script type="text/javascript" src="./js/libs/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="./js/libs/jquery-ui-1.10.1.custom.min.js"></script>

<script src="./js/Detector.js"></script>

<script src="./js/libs/three.min.js"></script>
<script src="./js/libs/physi.js"></script>

<script src="./js/libs/stats.min.js"></script>
<script src="./js/libs/dat.gui.min.js"></script>
<script src="./js/libs/tween.min.js"></script>

<script src="./js/controls/OrbitControls.js"></script>
<script src="./js/loaders/ColladaLoader.js"></script>

<script src="./js/utils.js"></script>
<script src="./js/camtweener.js"></script>
<script src="./js/rover.js"></script>
<script src="./js/outcrop.js"></script>
<script src="./js/mainRover.js"></script>


<script src="./js/sonic.js"></script>
		
<script type="text/javascript">
//need a value to maintain global user email to check for during session.
//the following variable and function provide separate backpack window to communicate user email value.
var userBackpackEmail;
function setUserBackpackEmail(emailValue) {
	userBackpackEmail = emailValue;
	console.log("user email set to: ",userBackpackEmail);
}

function roverpilotbadgefinish() {
	$("#roverpilotbadge").animate({opacity: 0.0}, 200, function() {
    	$("#roverpilotbadge").css('pointer-events', 'none');
    });
	$("#roverpilotbadgecomplete").animate({opacity: 1.0}, 200, function() {
    	$("#roverpilotbadgecomplete").css('pointer-events', 'auto');
    });
}

// ensure the web page (DOM) has loaded
document.addEventListener("DOMContentLoaded", function () {
//http://www.youtube.com/watch?v=P4boyXQuUIw - good 11 min long animatic of curiosity
//http://www.youtube.com/watch?v=_hN4XdS7NMY&list=PL56421C9A51D1F427 - how do rovers drive on mars
	
	var threedinitialized;
	var initializethreed = function() {
		if(!threedinitialized) {
			threedinitialized = true;
			console.log("initializing MSL on Mars... v:0.1");
	        init(); //init the 3D background.
	        animate();

	        gui.destroy();  //remove the test GUI (used by Ryan)
			
		}
	}
	
	//loader
	var infinityloader = new Sonic({

		width: 160,
		height: 80,

		stepsPerFrame: 2,
		trailLength: .35,
		pointDistance: .01,
		fps: 25,

		fillColor: '#FF7B24',

		setup: function() {
			this._.lineWidth = 3;
		},

		step: function(point, i, f) {

			var progress = point.progress,
				degAngle = 360 * progress,
				angle = Math.PI/180 * degAngle,
				angleB = Math.PI/180 * (degAngle - 180),
				size = i*3;

			this._.fillRect(
				Math.cos(angle) * 35 + (100-size/2),
				Math.sin(angle) * 15 + (50-size/2),
				size * .75,
				size * .75
			);
			
			this._.fillStyle = '#3a84a6';

			this._.fillRect(
				Math.cos(angleB) * 25 + (100-size/2),
				Math.sin(angleB) * 10 + (50-size/2),
				size,
				size
			);

			this._.fillStyle = '#FFF47A';

			this._.beginPath();
			this._.arc(100, 50, 5, 0, 360, 0);
			this._.closePath();
			this._.fill();


		},

		path: [
			['line', 20, 5, 30, 45]
		]
	 
	});
	

	//start popcorn definitions/array
	var popcornMedia = new Array();
	var popcornSequenceNumber = 0;
	popcornMedia[0] = Popcorn('#UNIT2_VO_intro' );
	popcornMedia[1] = Popcorn('#UNIT2_VO_1' );
	popcornMedia[2] = Popcorn('#UNIT2_VO_1e1' ); //call to action
	popcornMedia[3] = Popcorn('#UNIT2_VO_1e2' ); //if up wasn't used 
	popcornMedia[4] = Popcorn('#UNIT2_VO_2' ); //good job
	popcornMedia[5] = Popcorn('#UNIT2_VO_3' ); //lesson 2 calibration plate
	popcornMedia[6] = Popcorn('#UNIT2_VO_3e1' ); //call to action mast cam button
	popcornMedia[7] = Popcorn('#UNIT2_VO_3e2' ); //call to action no touch down
	popcornMedia[8] = Popcorn('#UNIT2_VO_4' ); //good job be sure of data (need to stow instruments)
	popcornMedia[9] = Popcorn('#UNIT2_VO_4a' ); // good job, calibrated! (show outcrops)
	popcornMedia[10] = Popcorn('#UNIT2_VO_4b' ); //great, outcrop found, run again 
	popcornMedia[11] = Popcorn('#UNIT2_VO_4e2' ); //call to action instruments used, not in front of outcrop
	popcornMedia[12] = Popcorn('#UNIT2_VO_4e3' ); //not what we're looking for
	popcornMedia[13] = Popcorn('#UNIT2_VO_conclusion' ); //badge
	
    popcornMedia[0].on( "play", function() {
    	console.log("on play");
    	//$("#youtubetarget").animate({opacity: 1.0}, 100, function() {
        //   	$("#youtubetarget").css('pointer-events', 'auto');
       	//});

    	$("#backgroundtarget").animate({opacity: 0.0}, 100, function() {
           	$("#backgroundtarget").css('pointer-events', 'none');
       	});
    	
		$("#nextbuttonwrapper").animate({opacity: 1.0}, 200, function() {
        	$("#nextbuttonwrapper").css('pointer-events', 'auto');
    	});
    	
		$("#playbuttonwrapper").animate({opacity: 1.0}, 200, function() {
        	$("#playbuttonwrapper").css('pointer-events', 'auto');
    	});
	});
    
    popcornMedia[0].cue( 1, function() {
        $("#rovercontrols").animate({opacity: 1.0}, 200, function() {
        	$("#rovercontrols").css('pointer-events', 'auto');
            $("#launchdiv").animate({opacity: 1.0}, 200, function() {
            	$("#launchdiv").css('pointer-events', 'auto');
        	});
    	});
        $("#pilotviewbutton").click();
        
	});
    
	popcornMedia[0].on( "ended", function() {
    	//$("#youtubetarget").animate({opacity: 0.0}, 100, function() {
        //   	$("#youtubetarget").css('pointer-events', 'none');
       	//});
    	advancePopcornMedia();
    	
    	
	});
	
	popcornMedia[1].on( "ended", function() {
    	//setup call to action

		document.addEventListener( 'keyup', onKeyUp, false );
	});
	
    popcornMedia[1].on( "ended", function() {
    	//the click/drag test
        lessonOpen=true;
        cancelCallToAction=false;
        callToActionTimeoutLesson1 = setTimeout(function(){callToActionUser()},10000);
        
    	$("#helpbuttonwrapper").animate({opacity: 1.0}, 200, function() {
        	$("#helpbuttonwrapper").css('pointer-events', 'auto');
    	});
    	
    	$("#replaybuttonwrapper").animate({opacity: 1.0}, 200, function() {
        	$("#replaybuttonwrapper").css('pointer-events', 'auto');
    	});
	});
    
    popcornMedia[4].on( "ended", function() {
    	//the click/drag test
    	advancePopcornMedia(5);
	});

    popcornMedia[5].cue( 1, function() {
    	ocCalibration.setPosition(0, 10); //always call set position first before showing target and arrow
    	ocCalibration.showTarget();
    	ocCalibration.showArrow();
	});
    popcornMedia[5].on( "ended", function() {
    	//the click/drag test
        lessonOpen=true;
	});
    
    popcornMedia[9].cue( 3, function() {
    	rover.stowArm();
    	//show outcrop
	});
    
    popcornMedia[9].cue( 5, function() {
    	//hide calibration plate
    	ocCalibration.hideTarget();
    	ocCalibration.hideArrow();
    	//swing camera back
	});
    popcornMedia[9].cue( 6, function() {
    	//swing camera back to wide view
    	$("#wideviewbutton").click();
    	
	});
    
    
	popcornMedia[9].cue( 9, function() {
    	//show outcrop
    	oc.setPosition(-20, 35);
    	oc.showTarget();
		oc.showArrow();
	});
    
	popcornMedia[9].cue( 11, function() {
    	//show outcrop
		ocTwo.setPosition(5,35);
		ocTwo.showTarget();
		ocTwo.showArrow();
	});
    
    popcornMedia[9].on( "ended", function() {
		//analyze rock first time.
        lessonOpen=true;
	});
    
    popcornMedia[10].on( "ended", function() {
		//analyze rock second time.
        lessonOpen=true;
	});
    
    $("#energybar").css({'background-color':'rgba(58,132,166,1.0)'});
	//increase energy bar by 1 every half second
	setInterval(function() { 
		if(currentEnergyLevel<=100) {
			currentEnergyLevel++;
			//our energy div visual reflect the opposite (full looks empty and vice versa)
			var flipNumber = 100-currentEnergyLevel;
		    $("#energylevel").css({height:(flipNumber+"%")});
			if(currentEnergyLevel<30) {
			    $("#energybar").css({'background-color':'rgba(250,30,30,1.0)'});
			} else {
			    $("#energybar").css({'background-color':'rgba(58,132,166,1.0)'});
			}
		}
	}, 200);
	
	function onKeyUp ( event ) {

		switch( event.keyCode ) {
			case 38: //up
				cancelCallToAction=true;
				document.removeEventListener( 'keyup', onKeyUp ); //this may break keyup elsewhere
				setTimeout(function(){advanceUser();}, 800);
				break;
			case 40: //down
				cancelCallToAction=true;
				setTimeout(function(){jumpPopcornMedia(3);}, 800);
				break;
			case 37: //left
				cancelCallToAction=true;
				setTimeout(function(){jumpPopcornMedia(3);}, 800);
				break;
			case 39: //right
				cancelCallToAction=true;
				setTimeout(function(){jumpPopcornMedia(3);}, 800);
				break;
		}
		
	};
	
	var callToActionLesson1;
	
    //setup vars to walk through mouse 3D lesson
    var cancelCallToAction=false;
    var userLessonNumber=0;
    var lessonOpen=false;
    
    var advanceUser = function () {
    	console.log("advancing user from: " + userLessonNumber);
		cancelCallToAction=false;
        lessonOpen=false;
		clearTimeout(callToActionLesson1);
		
		switch(userLessonNumber)
    	{
    	case 0:
			jumpPopcornMedia(4); //calibration plate
    	  break;
    	case 1:
			jumpPopcornMedia(9); //that's it! calibration success and move on to rocks
    	  break;
    	case 2:
			jumpPopcornMedia(10); //analyze rock, please analyze again.
	    	break;
    	case 3:
			jumpPopcornMedia(13);  //badge
	    	break;
    	default:
    	  //no default audio
    	}
		
    	userLessonNumber++; //update to next lesson
		
    }
    
    var callToActionUser = function () {
    	console.log("call to action: ", cancelCallToAction);
    	if(cancelCallToAction) return;
    	
    	switch(userLessonNumber)
    	{
    	case 0:
			jumpPopcornMedia(2);
    	  break;
    	default:
    	  //no default audio
    	}
    }
    
    var advancePopcornMedia = function () {
		popcornSequenceNumber++;
    	if(popcornSequenceNumber<popcornMedia.length) {
    		popcornMedia[popcornSequenceNumber].play(0);
    	}
    }
    
  //a way to skip around (needed for Next button and Menu buttons)
    var jumpPopcornMedia = function (sequenceNum, beginningOffset) {
		if(popcornSequenceNumber>=popcornMedia.length)return;
		popcornSequenceNumber=sequenceNum;
		//clear div targets
    	//hideeverything();
		
		//stop all other media
		for(var i=0;i<popcornMedia.length;i++) {
			popcornMedia[i].pause();
		}
		
		//jump to desired media
		if(beginningOffset) {
			popcornMedia[popcornSequenceNumber].play(beginningOffset);
		} else {
			popcornMedia[popcornSequenceNumber].play(0);
		}

		//show pause toggle
		$("#playtoggle").attr("class", "pause");
    }
  
    $(document).on('mousedown', function(e) {
		$("#menupanel").animate({opacity: 0.0}, 200, function() { $("#menupanel").css('pointer-events', 'none'); });
    });
  
    
    var aboutpopupclose = document.getElementById('aboutpopupclose');
    aboutpopupclose.style.cursor = 'pointer';
    aboutpopupclose.onclick = function() {
    	closeAllSubMenus();
    };
    
    var helppopupclose = document.getElementById('helppopupclose');
    helppopupclose.style.cursor = 'pointer';
    helppopupclose.onclick = function() {
    	closeAllSubMenus();
    };
    
    var helpthreedpopupclose = document.getElementById('helpthreedclose');
    helpthreedclose.style.cursor = 'pointer';
    helpthreedclose.onclick = function() {
    	closeAllSubMenus();
    };
    
    var browserpopupclose = document.getElementById('browserpopupclose');
    browserpopupclose.style.cursor = 'pointer';
    browserpopupclose.onclick = function() {
    	closeAllSubMenus();
    };
    
    var closeAllSubMenus = function() {

		$("#menupanel").animate({opacity: 0.0}, 1, function() { $("#menupanel").css('pointer-events', 'none'); });
    	$("#aboutpopup").animate({opacity: 0.0}, 200, function() {$("#aboutpopup").css('pointer-events', 'none');});
    	$("#helppopup").animate({opacity: 0.0}, 200, function() {$("#helppopup").css('pointer-events', 'none');});
    	$("#helpthreedpopup").animate({opacity: 0.0}, 200, function() {$("#helpthreedpopup").css('pointer-events', 'none');});
    	$("#browserpopup").animate({opacity: 0.0}, 200, function() {$("#browserpopup").css('pointer-events', 'none');});
    	$("#incomingmessage").animate({opacity: 0.0}, 200, function() {$("#incomingmessage").css('pointer-events', 'none');});
    	$("#cmemessage").animate({opacity: 0.0}, 200, function() {$("#cmemessage").css('pointer-events', 'none');});
		$("#transmissionmessage").animate({opacity: 0.0}, 1, function() { $("#transmissionmessage").css('pointer-events', 'none'); });
		
    }
	 
    var instrumentsbutton = document.getElementById('instrumentsbutton');
    instrumentsbutton.style.cursor = 'pointer';
    instrumentsbutton.onclick = function() {
    	console.log("rover armStowed: " + rover.armStowed);
    	
    	if(rover.armStowed) {
    		var duration = 4000;
        	rover.extendArm(duration);
        	if(lessonOpen) {
				
            	setTimeout(function(){
            		var theTargetSeen = checkInstrumentsOnTarget();
            		console.log("Target Seen: " + theTargetSeen);
            		//for procedural reasons... we're placing 3 test in front of 2 test in front of 1 test. (the both call advanceUser)  TODO: fix this!
            		if(userLessonNumber==3) {
        	    		if(theTargetSeen=="Outcrop 2") {
        	    			advanceUser();
        	    	    	rover.stowArm();
        	    		} else if (theTargetSeen=="Outcrop 1" || theTargetSeen=="Outcrop 3") {
        	    			jumpPopcornMedia(12);
        	    	    	rover.stowArm();
        	    		} else {
        	    			jumpPopcornMedia(11);
        	    	    	rover.stowArm();
        	    		}
            		}
            		
            		if(userLessonNumber==2) {
        	    		if(theTargetSeen=="Outcrop 2") {
        	    			advanceUser();
        	    	    	rover.stowArm();
        	    		} else if (theTargetSeen=="Outcrop 1" || theTargetSeen=="Outcrop 3") {
        	    			jumpPopcornMedia(12);
        	    	    	rover.stowArm();
        	    		} else {
        	    			jumpPopcornMedia(11);
        	    	    	rover.stowArm();
        	    		}
            		}
            		//first check to see if the lesson is live, if so call the audio
            		if(userLessonNumber==1) {
        	    		if(theTargetSeen=="Outcrop 1") {
        	    			advanceUser();
        	    		} else {
        	    			jumpPopcornMedia(7);
        	    	    	rover.stowArm();
        	    		}
            		}
            		
    	    	}, (duration+1000));
        	}
    	} else {
    		rover.stowArm();
    	}
    }
    $("#instrumentsbutton").hover(function() {
    	$("#instrumentsbutton").animate({opacity: 0.8}, 100, function() {
        });
    }, function() {
    	$("#instrumentsbutton").animate({opacity: 1.0}, 100, function() {
        });
    });

    var camsbutton = document.getElementById('camsbutton');
    camsbutton.style.cursor = 'pointer';
    camsbutton.onclick = function() {
    	rover.scanMast(4000);
    	setTimeout(function() {
        	//show outcrop
        	oc.setPosition(-20, 35);
        	oc.showTarget();
    		oc.showArrow();
    	},1000); 
    	setTimeout(function() {
        	//show outcrop
    		ocTwo.setPosition(5,35);
    		ocTwo.showTarget();
    		ocTwo.showArrow();
    	},3000); 
    }
    

	popcornMedia[9].cue( 9, function() {
    	//show outcrop
    	oc.setPosition(-20, 35);
    	oc.showTarget();
		oc.showArrow();
	});
    
	popcornMedia[9].cue( 11, function() {
    	//show outcrop
		ocTwo.setPosition(5,35);
		ocTwo.showTarget();
		ocTwo.showArrow();
	});
    
	popcornMedia[13].cue( 3, function() {
		//TODO: show badge

    	$("#roverpilotbadge").animate({opacity: 1.0}, 200, function() {
        	$("#roverpilotbadge").css('pointer-events', 'auto');
        });
	});
	
	//pop the mission complete
    var poproverpilotBadgeWindow = function() {
    	//first we should check to see if the user email has been stored
    	//if(userBackpackEmail) {}
    	
    	//then pop the appropriate window
    	var winWidth = 750;
    	var winHeight = 600;
    	badgeWindow = popupwindow("./badge-it-gadget-lite/process-badges/missionRoverPilotComplete.html",
    			"Rover Pilot Badge",winWidth, winHeight);
    }
	
    function popupwindow(url, title, w, h) {
  	  var left = (screen.width/2)-(w/2);
  	  var top = (screen.height/2)-(h/2);
  	  return window.open(url, title, "titlebar=no,toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=no,resizable=no,copyhistory=no,width="+w+", height="+h+", top="+top+", left="+left);
  }
	
    //generic popup window opening function
    var roverpilotbadgeuploadbutton = document.getElementById('roverpilotbadgeuploadbutton');
    roverpilotbadgeuploadbutton.onclick = function() {
    	poproverpilotBadgeWindow();
    };
    
    var roverpilotbadgeskipbutton = document.getElementById('roverpilotbadgeskipbutton');
    roverpilotbadgeskipbutton.onclick = function() {
    	$("#roverpilotbadge").animate({opacity: 0.0}, 200, function() {
        	$("#roverpilotbadge").css('pointer-events', 'none');
        });
    	
    	//setTimeout(function(){jumpPopcornMedia(24)},2000);
    };
    
    var roverpilotbadgecompletecontinuebutton = document.getElementById('roverpilotbadgecompletecontinuebutton');
    roverpilotbadgecompletecontinuebutton.onclick = function() {
    	$("#roverpilotbadgecomplete").animate({opacity: 0.0}, 200, function() {
        	$("#roverpilotbadgecomplete").css('pointer-events', 'none');
        });
    	$("#roverpilotbadgeskipbutton").click();
    };
    
    var roverpilotbadgecompletereplaybutton = document.getElementById('roverpilotbadgecompletereplaybutton');
    roverpilotbadgecompletereplaybutton.onclick = function() {
    	//this will take you back to the 3D navigation lesson.
    	$("#navigation").click();
    };
	
	var hideeverything = function() {
		$("#startmenupanel").animate({opacity: 0.0}, 1, function() { $("#startmenupanel").css('pointer-events', 'none'); });
		$("#menupanel").animate({opacity: 0.0}, 1, function() { $("#menupanel").css('pointer-events', 'none'); });
		
		$("#aboutpopup").animate({opacity: 0.0}, 1, function() { $("#aboutpopup").css('pointer-events', 'none'); });
		$("#helppopup").animate({opacity: 0.0}, 1, function() { $("#helppopup").css('pointer-events', 'none'); });
		$("#helpthreedpopup").animate({opacity: 0.0}, 1, function() { $("#helpthreedpopup").css('pointer-events', 'none'); });
		//$("#browserpopup").animate({opacity: 0.0}, 1, function() { $("#browserpopup").css('pointer-events', 'none'); });
		
		$("#incomingmessage").animate({opacity: 0.0}, 1, function() { $("#incomingmessage").css('pointer-events', 'none'); });
		$("#transmissionmessage").animate({opacity: 0.0}, 1, function() { $("#transmissionmessage").css('pointer-events', 'none'); });
		$("#cmemessage").animate({opacity: 0.0}, 1, function() { $("#cmemessage").css('pointer-events', 'none'); });

		$("#rovercontrols").animate({opacity: 0.0}, 1, function() { $("#rovercontrols").css('pointer-events', 'none'); });
		
		$("#nextbuttonwrapper").animate({opacity: 0.0}, 1, function() { $("#nextbuttonwrapper").css('pointer-events', 'none'); });
		$("#helpbuttonwrapper").animate({opacity: 0.0}, 1, function() { $("#helpbuttonwrapper").css('pointer-events', 'none'); });
		$("#replaybuttonwrapper").animate({opacity: 0.0}, 1, function() { $("#replaybuttonwrapper").css('pointer-events', 'none'); });
		

		$("#roverpilotbadge").animate({opacity: 0.0}, 1, function() { $("#roverpilotbadge").css('pointer-events', 'none'); });
		$("#roverpilotbadgecomplete").animate({opacity: 0.0}, 1, function() { $("#roverpilotbadgecomplete").css('pointer-events', 'none'); });

	}
	
    $("#camsbutton").hover(function() {
    	$("#camsbutton").animate({opacity: 0.8}, 100, function() {
        });
    }, function() {
    	$("#camsbutton").animate({opacity: 1.0}, 100, function() {
        });
    });
    
    var checkInstrumentsOnTarget = function() {
    	var returnVal;
    	for( var i = 0; i < OUTCROPS.length; i++ ){
    		if( OUTCROPS[i].touchdown( rover.arm.hand, .75 ) )  {
    			console.log( "The Rover eye saw " + OUTCROPS[i].name );
    			return returnVal = OUTCROPS[i].name;
    		} else {
    			returnVal = null;
    		}
    	}
    	return returnVal;
    }
    
    var checkRoverOnTarget = function() {
    	var returnVal;
    	for( var i = 0; i < OUTCROPS.length; i++ ){
    		if( OUTCROPS[i].touchdown( rover.mesh, .75 ) ) { 
    			console.log( "Ran over " + OUTCROPS[i].name + " got a touchdown" );
    			return returnVal = OUTCROPS[i].name;
    		} else {
    			returnVal = null;
    		}
    	}
    	return returnVal;
    }
    
    var replayUser = function () {

		lessonOpen=false;
	    cancelCallToAction=true;
	    
	    switch(userLessonNumber)
    	{
    	case 0:
			jumpPopcornMedia(1); //drive forward
    	  break;
    	case 1:
			jumpPopcornMedia(5); //analyze rock
    	  break;
    	case 2:
			jumpPopcornMedia(9,4); //analyze rock analyze again.
	    	break;
    	case 3:
			jumpPopcornMedia(10);  //badge
	    	break;
    	default:
    	  //no default audio
    	}
    }
	
	$(document).ready( function() {
		infinityloader.play();
		var div = document.getElementById("canvastarget"); 
		div.appendChild(infinityloader.canvas);
		
		if ( ! Detector.webgl ) Detector.addGetWebGLMessage();
		var postColladaLoaded = function () {
			initializethreed();
			$("#loadtext").hide();
			
			setTimeout(function() {

		        div.removeChild(infinityloader.canvas);
		        $("#loaderdiv").animate({opacity: 0.0}, 500, function() {
		            $("#loaderdiv").css('pointer-events', 'none');
		        });
				
			},2000)

	    };

		roverLoader.options.convertUpAxis = true;
		roverLoader.load( './models/rover.dae', function ( collada ) {

			rover_dae = collada.scene;
			rover_dae.scale.set( 1, 1, 1 );
			rover_dae.updateMatrix();

			terrainLoader.options.convertUpAxis = true;
			terrainLoader.load( './models/terrain.dae', function ( collada ) {
				
				terrain = collada.scene;
				terrain.scale.set( 1, 1, 1 );
				postColladaLoaded();
			});
		});
		
		$( "#beginbutton" )
			.button()
			.click(function( event ) {
				popcornMedia[0].play( 0 );
				$("#startmenupanel").animate({opacity: 0.0}, 200, function() {
                	$("#startmenupanel").css('pointer-events', 'none');
            	});
		    	$("#backgroundtarget").animate({opacity: 0.0}, 1000, function() {
		           	$("#backgroundtarget").css('pointer-events', 'none');
		       	});
		});
		
		$('#playtoggle').bind("click", function() {
          if ($(this).attr("class") == "play") {
             $(this).attr("class", "pause");
 			popcornMedia[popcornSequenceNumber].play();
          } else {
             $(this).attr("class", "play");
 			popcornMedia[popcornSequenceNumber].pause();
          }
        });
		
		$( "#menubutton" )
			.button()
			.click(function( event ) {
				if($('#menupanel').css('opacity') != 0) {
	            	$("#menupanel").animate({opacity: 0.0}, 200, function() {
	                	$("#menupanel").css('pointer-events', 'none');
	            	});
	        	} else {
	        		$("#menupanel").animate({opacity: 1.0}, 200, function() {
	                	$("#menupanel").css('pointer-events', 'auto');
	            	});
	        	}
		});
		
		
		$( "#nextbutton" )
			.button()
			.click(function( event ) {
				if(popcornSequenceNumber<5) {
					jumpToThreeDNavigation();
				} else if(popcornSequenceNumber<17) {
					jumpToChallenge();
				}
		});

		$( "#replaybutton" )
			.button()
			.click(function( event ) {
				replayUser();
		});
		
		$( "#threedhelpbutton" )
			.button()
			.click(function( event ) {
				$("#helpthreedpopup").animate({opacity: 1.0}, 200, function() {
	            	$("#helpthreedpopup").css('pointer-events', 'auto');
	        	});
		});
		
		$( "#introduction" )
			.button()
			.click(function( event ) {
				$("#menupanel").animate({opacity: 0.0}, 1, function() { $("#menupanel").css('pointer-events', 'none'); });
				jumpToIntroduction();
		});
		$( "#navigation" )
			.button()
			.click(function( event ) {
				$("#menupanel").animate({opacity: 0.0}, 1, function() { $("#menupanel").css('pointer-events', 'none'); });
				jumpToThreeDNavigation();
		});
		
		$( "#challenge" )
			.button()
			.click(function( event ) {
				$("#menupanel").animate({opacity: 0.0}, 1, function() { $("#menupanel").css('pointer-events', 'none'); });
				jumpToChallenge();
		});

		$( "#about" )
			.button()
			.click(function( event ) {
				$("#aboutpopup").animate({opacity: 1.0}, 200, function() {
	            	$("#aboutpopup").css('pointer-events', 'auto');
	        	});
				$("#menupanel").animate({opacity: 0.0}, 1, function() { $("#menupanel").css('pointer-events', 'none'); });
				
		});


		$( "#help" )
			.button()
			.click(function( event ) {
				console.log("clicked help");
				$("#helppopup").animate({opacity: 1.0}, 200, function() {
	            	$("#helppopup").css('pointer-events', 'auto');
	        	});
				$("#menupanel").animate({opacity: 0.0}, 1, function() { $("#menupanel").css('pointer-events', 'none'); });
				
		});

		$( "#pilotviewbutton" )
			.button()
			.click(function( event ) {
		    	camTweener( { x:0, y:4, z:-10 }, { x:0, y:0, z:0 }, 1500 );
		});

		$( "#sideviewbutton" )
			.button()
			.click(function( event ) {
		    	camTweener( { x:-5, y:3, z:-2 }, { x:0, y:0, z:0 }, 2000 );
		});

		$( "#wideviewbutton" )
			.button()
			.click(function( event ) {
		    	camTweener( { x:0, y:8, z:-20 }, { x:0, y:0, z:0 }, 3000 );
		});

	});

}, false);

</script>
	</head>

	<body>

		<div id="startmenupanel" class="startmenupanel">
			<h1>The MSL Curiosity</h1>
			<br>
			<div class="textstyle1">
			In this simulation of exploring the Mars Science Lab Curiosity you will use a 3D model of the Curiosity on Mars to learn
			about the science behind the rover.
			</div>
			<br>
			<button id="beginbutton" class="beginbutton">BEGIN</button>
			<br>
			<br>
			<br>
			<div class="textstyle2">
			This project is a collaboration between the U.S. Department of Energy, the Mozilla Foundation, and MX.</div>
			<br>
			<img src="./images/tri_logo.png" style="align: center;">
			<br>
		</div>
	
		<div id="topbar" class="topbar">
		
			<div id="topbarleft" class="topbarleft">
				<div id="headerpanel" class="headerpanel"></div>
			</div>
			<div id="topbarmiddle" class="topbarmiddle">
				<div id="loaderdiv" style="z-index:10;opacity:1.0;pointer-events:auto; width:100%">
					<div id="loaderpanel" class="loadercontenttarget" style="z-index:11;">
						<font style="color:#3a84a6;">Loading the Curiosity MSL</font>
						<div id="canvastarget" style="position:absolute;left:-130px;top:-22px"></div>
					</div>
				</div>
			</div>
			
			<div id="topbarright" class="topbarright">
				<button id="menubutton" class="menubutton">MENU</button>
				<div id="menupanel" class="menupanel">
					<button id="introduction" class="menupanelbutton">introduction</button>
					<br>
					<button id="navigation" class="menupanelbutton">3d navigation</button>
					<br>
					<button id="challenge" class="menupanelbutton">Slayton's Isle</button>
					<br>
					<button id="about" class="menupanelbutton">about</button>
					<br>
					<button id="help" class="menupanelbutton">help</button>
				</div>
			</div>
		</div>	
		<!-- main content area for video, images, 3D, etc... -->
		<div id="contenttarget" class="contenttarget">
		</div>
		<div id="youtubetarget" class="youtubetarget"></div>
		<div id="backgroundtarget" class="curiositybackgroundtarget">
		</div>
		
		<div id="bottombar" class="bottombar">
			<div id="bottombarleft" class="bottombarleft">
				<div id="helpbuttonwrapper" class="helpbuttonwrapper" style="opacity: 0.0;pointer-events:none">
					<button id="threedhelpbutton" class="threedhelpbutton">HELP</button>
				</div>
				<div id="replaybuttonwrapper" class="replaybuttonwrapper" style="opacity: 0.0;pointer-events:none">
					<button id="replaybutton" class="replaybutton">REPLAY</button>
				</div>
			</div>
			<div id="bottombarmiddle" class="bottombarmiddle" style="vertical-align: middle;">
				<div id="threedcontrols" class="threedcontrols">
					<button id="threedhome" class="squarebluebutton">Home</button>
					<button id="threedrover" class="squarebluebutton">Rover</button>
					<button id="threedearth" class="squarebluebutton">Earth</button>
					<button id="threedmars" class="squarebluebutton">Mars</button>
				</div>
			</div>
			
			<div id="bottombarright" class="bottombarright">
				
				<div id="nextbuttonwrapper" class="nextbuttonwrapper" style="opacity: 0.0;pointer-events:none">
					<div id="playbuttonwrapper" class="playbuttonwrapper" style="opacity: 0.0;pointer-events:none">
						<div id="playtoggle" class="pause"></div>
					</div>
					<button id="nextbutton" class="nextbutton">SKIP</button>
				</div>
			</div>
		</div>
		
		<div id="aboutpopup" class="popupdiv">
			<div id="aboutpopupclose" class="closebutton"><p>&#10006;</p></div>
			<h1>About</h1>
			<p>A 3D web experience built in conjuction with MX, the Deparment of Energy and Mozilla.  
			We have combined <a href="http://popcornjs.org/" target="_new">Popcorn</a> with a 3D experience to all on a Mars journey.
			</p>
		</div>
		<div id="helppopup" class="popupdiv">
			<div id="helppopupclose" class="closebutton"><p>&#10006;</p></div>
			<h1>Help</h1>
			<p>The help page</p>
		</div>
		<div id="helpthreedpopup" class="popupdiv">
			<div id="helpthreedclose" class="closebutton"><p>&#10006;</p></div>
			<h1>Help</h1>
			<p>The 3D help page</p>
		</div>
		<div id="browserpopup" class="popupdiv">
			<div id="browserpopupclose" class="closebutton"><p>&#10006;</p></div>
			<h1>Browser</h1>
			<p>The browser page</p>
		</div>
		
		<div id="incomingmessage" class="capcommessagediv">
			<table style="width: 100%;margin:2;padding:0;" >
				<tr >
					<td width="50px" rowspan="2" align="left" valign="middle"><img src="./images/icon_satellite.png" style="width:45px;height:45px;"></td>
					
					<td align="left">...Incoming Transmission</td>
				</tr>
				<tr>
					<td align="left">
						<button id="answerbutton" class="squarebluebutton">Answer</button>
						<button id="ignorebutton" class="squarebluebutton">Ignore</button>
					</td>
				</tr>
			</table>
		</div>
		
		<div id="transmissionmessage" class="capcommessagediv">
			<table style="width: 100%;margin:2;padding:0;" >
				<tr >
					<td width="50px" rowspan="2" align="left" valign="middle"><img src="./images/icon_satellite.png" style="width:45px;height:45px;"></td>
					<td align="left">Current Transmission:</td>
				</tr>
				<tr>
					<td align="left" style="font-weight:400;"> Nasa - Capcom </td>
				</tr>
			</table>
		</div>
		
		<div id="cmemessage" class="capcommessagereddiv">
			<table style="width: 100%;margin:2;padding:0;" >
				<tr >
					<td width="50px" rowspan="2" align="left" valign="middle"><img src="./images/cme_icon.png" style="width:45px;height:45px;"></td>
					
					<td align="left">Alert: CME Detected!</td>
				</tr>
				<tr>
					<td align="left">
						<button id="investigatecmebutton" class="roundedredbutton">Investigate</button>
						<button id="ignorecmebutton" class="roundedredbutton">Ignore</button>
					</td>
				</tr>
			</table>
		</div>
		
		<div id="rovercontrols" class="launchcontrols">
			
			<div id="datediv" class="datediv" >
				<table style="width:100%;height:100%;margin:0;padding:0;" >
					<tr>
						<td align="center" valign="bottom" height="20px">Energy</td>
						<td align="center" valign="bottom">Power Source</td>
						<td align="center" valign="bottom">Mast Cams</td>
						<td align="center" valign="bottom">Instruments</td>
					</tr>
					<tr>
						<td align="center" valign="middle" style="height:54px;width:80px;">
							<div id="energybar" class="energybar">
								<div id="energylevel" class="energylevel"></div>
							</div>
							
						</td>
						<td align="center" valign="middle" style="height:54px;width:110px;">
							<img src="./images/icon_rtg.png" >
						</td>
						<td align="center" valign="middle" style="height:54px;width:110px;">
							<img id="camsbutton" src="./images/icon_mastcams.png">
						</td>
						<td align="center" valign="middle" style="height:54px;width:110px;">
							<img id="instrumentsbutton" src="./images/icon_instruments.png">
						</td>
					</tr>
				</table>
			</div>
			
			<div id="launchdiv" class="launchdiv" >
				<table style="width:100%;height:100%;margin:0;padding:0;">
					<tr>
						<td align="center" valign="bottom" height="20px"></td>
						<td align="center" valign="bottom">Camera Views</td>
						<td align="center" valign="bottom"></td>
					</tr>
					<tr>
						<td align="center" valign="middle" style="height:54px;width:110px;">
				 			<button id="pilotviewbutton" class="playbutton" style="padding:2px 9px">
								<table style="width:70px;height:100%;margin:0;padding:0;">
									<tr>
										<td id="pilotviewbutton">Pilot View</td>
									</tr>
								</table>
							</button>
						</td>
						<td align="center" valign="middle" style="height:54px;width:110px;">
				 			<button id="wideviewbutton" class="playbutton" style="padding:2px 9px">
								<table style="width:60px;height:100%;margin:0;padding:0;">
									<tr>
										<td id="wideviewbutton">Wide View</td>
									</tr>
								</table>
							</button>
						</td>
						<td align="center" valign="middle" style="height:54px;width:110px;">
				 			<button id="sideviewbutton" class="playbutton" style="padding:2px 9px">
								<table style="width:60px;height:100%;margin:0;padding:0;">
									<tr>
										<td id="sideviewbutton">Side View</td>
									</tr>
								</table>
							</button>
						</td>
						
					</tr>
				</table>
			</div>
		</div>
		
		<div id="roverpilotbadge" class="modalmask">
			<div id="backpacklogindiv" class="badgecontenttarget">
				<h1>Mission Complete!</h1>
				<h1>Badge Award!</h1>
				<br>
				Upload your Badge
				<br><br>
				<div style="text-align: center;width:100%">
					<table style="position: absolute; width: 80%;margin:0;padding:0; float:middle;left:15%" >
						<tr >
							<td align="left" valign="top">
								<br>
								<font style="font-weight:300;">
								The Rover Pilot Badge awarded for 3D simulation mastery.
								<br><br>
								 - driving rover
								<br>
								 - calibrating instruments
								<br>
								 - finding evidence
								<br>
								 - confirming evidence
								 </font>
							
							</td>
							<td align="right" valign="top"><img src="./badge-it-gadget-lite/digital-badges/images/badge_driver.png"> </td>
							
						</tr>
					</table>
				</div>
					
				<br><br><br><br><br><br><br><br><br><br><br><br>
					<div style="float:middle;">
						<button id="roverpilotbadgeskipbutton" class="squarebluebutton">Skip</button>
						<button id="roverpilotbadgeuploadbutton" type="submit" class="squarebluebutton">Upload</button>
					</div>
			</div>
		</div>
		
		<div id="roverpilotbadgecomplete" class="modalmask">
			<div id="backpacklogindiv" class="badgecontenttarget">
				<h1>Mission Complete!</h1>
				<h1>Badge Award!</h1>
				<br>
				Thanks for playing
				<br><br>
				<div style="text-align: center;width:100%">
					<table style="position: absolute; width: 80%;margin:0;padding:0; float:middle;left:15%" >
						<tr >
							<td align="left" valign="top">
								<br>
								<font style="font-weight:300;">
								Congratulations and thanks. 
								 </font>
							
							</td>
							<td align="right" valign="top"><img src="./badge-it-gadget-lite/digital-badges/images/badge_driver.png"> </td>
							
						</tr>
					</table>
				</div>
					
				<br><br><br><br><br><br><br><br><br><br><br><br>
					<div style="float:middle;">
						<button id="roverpilotbadgecompletereplaybutton" class="squarebluebutton">Replay</button>
						<button id="roverpilotbadgecompletecontinuebutton" type="submit" class="squarebluebutton">Continue</button>
					</div>
			</div>
		</div>
		
		<audio id="UNIT2_VO_intro">
			<source src="http://www.mx-mx.com/lab/moku/audio/UNIT2_VO_intro.mp3"></source>
			<source src="http://www.mx-mx.com/lab/moku/audio/UNIT2_VO_intro.oggvorbis.ogg"></source>
		</audio> 
		
		<audio id="UNIT2_VO_1">
			<source src="http://www.mx-mx.com/lab/moku/audio/UNIT2_VO_1.mp3"></source>
			<source src="http://www.mx-mx.com/lab/moku/audio/UNIT2_VO_1.oggvorbis.ogg"></source>
		</audio> 
		
		<audio id="UNIT2_VO_1e1">
			<source src="http://www.mx-mx.com/lab/moku/audio/UNIT2_VO_1e1.mp3"></source>
			<source src="http://www.mx-mx.com/lab/moku/audio/UNIT2_VO_1e1.oggvorbis.ogg"></source>
		</audio> 
		
		<audio id="UNIT2_VO_1e2">
			<source src="http://www.mx-mx.com/lab/moku/audio/UNIT2_VO_1e2.mp3"></source>
			<source src="http://www.mx-mx.com/lab/moku/audio/UNIT2_VO_1e2.oggvorbis.ogg"></source>
		</audio> 
		
		<audio id="UNIT2_VO_2">
			<source src="http://www.mx-mx.com/lab/moku/audio/UNIT2_VO_2.mp3"></source>
			<source src="http://www.mx-mx.com/lab/moku/audio/UNIT2_VO_2.oggvorbis.ogg"></source>
		</audio> 
		
		<audio id="UNIT2_VO_3">
			<source src="http://www.mx-mx.com/lab/moku/audio/UNIT2_VO_3.mp3"></source>
			<source src="http://www.mx-mx.com/lab/moku/audio/UNIT2_VO_3.oggvorbis.ogg"></source>
		</audio> 
		
		<audio id="UNIT2_VO_3e1">
			<source src="http://www.mx-mx.com/lab/moku/audio/UNIT2_VO_3e1.mp3"></source>
			<source src="http://www.mx-mx.com/lab/moku/audio/UNIT2_VO_3e1.oggvorbis.ogg"></source>
		</audio> 
		
		<audio id="UNIT2_VO_3e2">
			<source src="http://www.mx-mx.com/lab/moku/audio/UNIT2_VO_3e2.mp3"></source>
			<source src="http://www.mx-mx.com/lab/moku/audio/UNIT2_VO_3e2.oggvorbis.ogg"></source>
		</audio> 
		
		<audio id="UNIT2_VO_4">
			<source src="http://www.mx-mx.com/lab/moku/audio/UNIT2_VO_4.mp3"></source>
			<source src="http://www.mx-mx.com/lab/moku/audio/UNIT2_VO_4.oggvorbis.ogg"></source>
		</audio> 
		
		<audio id="UNIT2_VO_4a">
			<source src="http://www.mx-mx.com/lab/moku/audio/UNIT2_VO_4a.mp3"></source>
			<source src="http://www.mx-mx.com/lab/moku/audio/UNIT2_VO_4a.oggvorbis.ogg"></source>
		</audio> 
		
		<audio id="UNIT2_VO_4b">
			<source src="http://www.mx-mx.com/lab/moku/audio/UNIT2_VO_4b.mp3"></source>
			<source src="http://www.mx-mx.com/lab/moku/audio/UNIT2_VO_4b.oggvorbis.ogg"></source>
		</audio> 
		
		<audio id="UNIT2_VO_4e1">
			<source src="http://www.mx-mx.com/lab/moku/audio/UNIT2_VO_4e1.mp3"></source>
			<source src="http://www.mx-mx.com/lab/moku/audio/UNIT2_VO_4e1.oggvorbis.ogg"></source>
		</audio> 
		
		<audio id="UNIT2_VO_4e2">
			<source src="http://www.mx-mx.com/lab/moku/audio/UNIT2_VO_4e2.mp3"></source>
			<source src="http://www.mx-mx.com/lab/moku/audio/UNIT2_VO_4e2.oggvorbis.ogg"></source>
		</audio> 
		
		<audio id="UNIT2_VO_4e3">
			<source src="http://www.mx-mx.com/lab/moku/audio/UNIT2_VO_4e3.mp3"></source>
			<source src="http://www.mx-mx.com/lab/moku/audio/UNIT2_VO_4e3.oggvorbis.ogg"></source>
		</audio> 
		
		<audio id="UNIT2_VO_conclusion">
			<source src="http://www.mx-mx.com/lab/moku/audio/UNIT2_VO_conclusion.mp3"></source>
			<source src="http://www.mx-mx.com/lab/moku/audio/UNIT2_VO_conclusion.oggvorbis.ogg"></source>
		</audio> 

	<!-- old divs by Ryan, probably unneeded -->
	<div id="loadtext"></div>
	<div id="info"></div>
	</body>
</html>
